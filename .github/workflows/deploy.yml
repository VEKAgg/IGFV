name: Deploy IGFV

on:
  push:
    branches: [main]

env:
  CONTAINER_NAME: igfv
  APP_NETWORK: proxy-network

jobs:
  deploy:
    runs-on: [self-hosted, Linux, X64, Veka]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate version
        id: version
        run: |
          VERSION=$(date +%Y%m%d-%H%M%S)
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Building version: $VERSION"

      # CRITICAL: Build and validate BEFORE touching production
      - name: Build and validate new image
        id: build
        run: |
          export VERSION=${{ steps.version.outputs.VERSION }}

          echo "üî® Building IGFV image..."
          docker build -t igfv:$VERSION -t igfv:candidate .

          echo "‚úÖ IGFV image built successfully"

          echo "üß™ Testing new image before deployment..."

          # Start test container
          docker run -d \
            --name igfv-test \
            --network ${{ env.APP_NETWORK }} \
            --env-file .env \
            -e NODE_ENV=production \
            -e NEXT_TELEMETRY_DISABLED=1 \
            igfv:candidate

          echo "‚è≥ Waiting for IGFV to initialize..."
          sleep 20

          # Health check
          TEST_IP=$(docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' igfv-test)
          echo "üìç Test container IP: $TEST_IP"

          # Validate with retries
          for i in {1..15}; do
            if curl -sf --max-time 10 http://$TEST_IP:5002 > /dev/null; then
              echo "‚úÖ New image passed health check (attempt $i/15)"
              
              # Check response headers
              echo "üìä Response headers:"
              curl -sI http://$TEST_IP:5002 | grep -E "(HTTP|Content-Type|X-Powered-By)" || true
              
              # Cleanup test container
              docker stop igfv-test
              docker rm igfv-test
              echo "‚úÖ Pre-validation passed - safe to deploy"
              exit 0
            fi
            echo "‚è≥ Testing... ($i/15)"
            sleep 5
          done

          # Failed validation - DO NOT DEPLOY
          echo "‚ùå New image FAILED health check"
          echo "üõë ABORTING deployment to protect production"
          echo ""
          echo "Container logs:"
          docker logs igfv-test --tail 100

          docker stop igfv-test
          docker rm igfv-test
          exit 1

      # Only execute if validation passed
      - name: Replace container (fast swap)
        run: |
          export VERSION=${{ steps.version.outputs.VERSION }}

          echo "‚ö° Fast-replacing production container..."

          # Quick stop and remove
          docker stop ${{ env.CONTAINER_NAME }} 2>/dev/null || true
          docker rm ${{ env.CONTAINER_NAME }} 2>/dev/null || true

          # Start new container immediately
          docker run -d \
            --name ${{ env.CONTAINER_NAME }} \
            --network ${{ env.APP_NETWORK }} \
            --env-file .env \
            -e NODE_ENV=production \
            -e NEXT_TELEMETRY_DISABLED=1 \
            --restart unless-stopped \
            --label "com.igfv.version=$VERSION" \
            igfv:$VERSION

          echo "‚úÖ Container replaced (downtime: ~2-5 seconds)"

      - name: Connect to proxy network
        run: |
          echo "üîó Connecting to proxy-network..."
          docker network connect proxy-network ${{ env.CONTAINER_NAME }} 2>/dev/null || echo "Already connected"
          echo "‚úÖ Connected to proxy-network"

      - name: Verify production deployment
        timeout-minutes: 3
        run: |
          echo "üîç Verifying production container..."

          sleep 8

          # Check container is running
          if ! docker ps | grep -q ${{ env.CONTAINER_NAME }}; then
            echo "‚ùå Container not running"
            docker logs ${{ env.CONTAINER_NAME }} --tail 100
            exit 1
          fi

          echo "‚úÖ Container is running"

          # Get container IP
          CONTAINER_IP=$(docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' ${{ env.CONTAINER_NAME }})
          echo "üìç Container IP: $CONTAINER_IP"

          # Quick health check (already pre-validated)
          for i in {1..10}; do
            if curl -sf --max-time 10 http://$CONTAINER_IP:5002 > /dev/null; then
              echo "‚úÖ Production container healthy (attempt $i/10)"
              
              echo "üìä Server info:"
              curl -sI http://$CONTAINER_IP:5002 | grep -E "(HTTP|X-Powered-By)" || true
              
              exit 0
            fi
            echo "‚è≥ Waiting... ($i/10)"
            sleep 6
          done

          echo "‚ö†Ô∏è Production container slow to respond (but pre-validation passed)"
          docker logs ${{ env.CONTAINER_NAME }} --tail 50

      - name: Test via NPM
        continue-on-error: true
        run: |
          echo "üåê Testing public access via NPM..."

          if docker exec nginx-proxy-manager curl -sf http://igfv:5002 > /dev/null 2>&1; then
            echo "‚úÖ NPM can reach container"
          else
            echo "‚ö†Ô∏è NPM cannot reach container (check NPM proxy host config)"
          fi

      - name: Cleanup old images
        if: success()
        run: |
          echo "üßπ Cleaning up old images..."

          # Keep last 3 versions + candidate tag
          docker images igfv --format "{{.ID}} {{.CreatedAt}}" | \
            sort -rk 2 | tail -n +5 | awk '{print $1}' | \
            xargs -r docker rmi -f 2>/dev/null || true

          docker image prune -f
          echo "‚úÖ Cleanup complete"

      - name: Emergency rollback
        if: failure()
        run: |
          echo "üö® DEPLOYMENT FAILED"

          # If pre-validation failed, production was never touched
          if docker ps | grep -q ${{ env.CONTAINER_NAME }}; then
            echo "‚ÑπÔ∏è Production container still running (pre-validation failed)"
            exit 0
          fi

          # If we got here, replacement happened but verification failed
          echo "üîÑ Attempting emergency rollback..."

          # Stop failed container
          docker stop ${{ env.CONTAINER_NAME }} 2>/dev/null || true
          docker rm ${{ env.CONTAINER_NAME }} 2>/dev/null || true

          # Get previous image (second in list)
          PREV_IMAGE=$(docker images igfv --format "{{.ID}}" | sed -n '2p')

          if [ -n "$PREV_IMAGE" ]; then
            echo "üîÑ Starting previous version..."
            
            docker run -d \
              --name ${{ env.CONTAINER_NAME }} \
              --network ${{ env.APP_NETWORK }} \
              --env-file .env \
              -e NODE_ENV=production \
              -e NEXT_TELEMETRY_DISABLED=1 \
              --restart unless-stopped \
              $PREV_IMAGE
            
            docker network connect proxy-network ${{ env.CONTAINER_NAME }} 2>/dev/null || true
            
            sleep 15
            
            if docker ps | grep -q ${{ env.CONTAINER_NAME }}; then
              echo "‚úÖ Rolled back to previous version"
              
              CONTAINER_IP=$(docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' ${{ env.CONTAINER_NAME }})
              if curl -sf --max-time 10 http://$CONTAINER_IP:5002 > /dev/null; then
                echo "‚úÖ Rollback successful - site is responding"
              fi
            else
              echo "‚ùå Rollback failed - manual intervention required"
              docker logs ${{ env.CONTAINER_NAME }} --tail 50
            fi
          else
            echo "‚ùå No previous image found for rollback"
            echo "‚ö†Ô∏è Manual recovery needed"
          fi

      - name: Deployment summary
        if: always()
        run: |
          STATUS="${{ job.status }}"

          echo "========================================"
          if [ "$STATUS" = "success" ]; then
            echo "‚úÖ NEXT.JS DEPLOYMENT SUCCESSFUL"
            echo "========================================"
            echo "üåê Site: https://igfv.veka.gg"
            echo "üì¶ Version: ${{ steps.version.outputs.VERSION }}"
            echo "‚ö° Framework: Next.js"
            echo "‚è±Ô∏è Downtime: ~2-5 seconds"
            echo "üõ°Ô∏è Pre-validated before swap"
            echo "‚è∞ Deployed: $(date '+%Y-%m-%d %H:%M:%S')"
            echo ""
            echo "üîó Access points:"
            echo "  - Public: https://igfv.veka.gg"
            echo "  - NPM: http://192.168.1.97 ‚Üí igfv:5002"
            echo "  - Direct: http://$(docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' ${{ env.CONTAINER_NAME }}):5002"
            echo ""
            echo "üìä Current status:"
            docker ps --filter "name=igfv" --format "table {{.Names}}\t{{.Status}}\t{{.Image}}"
          else
            echo "‚ùå DEPLOYMENT FAILED"
            echo "========================================"
            echo "üõ°Ô∏è Production protected by pre-validation"
            echo ""
            echo "üìä Current containers:"
            docker ps -a --filter "name=igfv" --format "table {{.Names}}\t{{.Status}}\t{{.Image}}"
            echo ""
            echo "üîç Troubleshooting:"
            echo "  1. Check build logs above"
            echo "  2. Review container logs: docker logs igfv"
            echo "  3. Test container manually: docker logs igfv-test (if exists)"
            echo "  4. Verify .next folder was created during build"
            echo ""
            echo "üí° If production is down, rollback was attempted automatically"
          fi
          echo "========================================"

