name: Deploy IGFV

on:
  push:
    branches: [main]

env:
  CONTAINER_NAME: igfv
  APP_NETWORK: proxy-network

jobs:
  deploy:
    runs-on: [self-hosted, Linux, X64, Veka]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate version
        id: version
        run: |
          VERSION=$(date +%Y%m%d-%H%M%S)
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Building version: $VERSION"

      # CRITICAL: Build and validate BEFORE touching production
      - name: Build and validate new image
        id: build
        run: |
          export VERSION=${{ steps.version.outputs.VERSION }}

          echo "ğŸ”¨ Building new image..."
          docker build -t igfv:$VERSION -t igfv:candidate .

          echo "âœ… Image built with Brotli + Gzip pre-compression"

          echo "ğŸ§ª Testing new image before deployment..."

          # Start test container
          docker run -d \
            --name igfv-test \
            --network ${{ env.APP_NETWORK }} \
            --env-file .env \
            -e NODE_ENV=production \
            igfv:candidate

          echo "â³ Waiting for container to initialize..."
          sleep 15

          # Health check
          TEST_IP=$(docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' igfv-test)
          echo "ğŸ“ Test container IP: $TEST_IP"

          # Validate with retries
          for i in {1..12}; do
            if curl -sf --max-time 5 http://$TEST_IP:5002 > /dev/null; then
              echo "âœ… New image passed health check (attempt $i/12)"
              
              # Check compression
              ENCODING=$(curl -sI -H "Accept-Encoding: br, gzip" http://$TEST_IP:5002 | grep -i content-encoding || echo "")
              if [ -n "$ENCODING" ]; then
                echo "ğŸ“Š $ENCODING"
              fi
              
              # Cleanup test container
              docker stop igfv-test
              docker rm igfv-test
              echo "âœ… Pre-validation passed - safe to deploy"
              exit 0
            fi
            echo "â³ Testing... ($i/12)"
            sleep 5
          done

          # Failed validation - DO NOT DEPLOY
          echo "âŒ New image FAILED health check"
          echo "ğŸ›‘ ABORTING deployment to protect production"
          echo ""
          echo "Container logs:"
          docker logs igfv-test --tail 100

          docker stop igfv-test
          docker rm igfv-test
          exit 1

      # Only execute if validation passed
      - name: Replace container (fast swap)
        run: |
          export VERSION=${{ steps.version.outputs.VERSION }}

          echo "âš¡ Fast-replacing production container..."

          # Quick stop and remove
          docker stop ${{ env.CONTAINER_NAME }} 2>/dev/null || true
          docker rm ${{ env.CONTAINER_NAME }} 2>/dev/null || true

          # Start new container immediately
          docker run -d \
            --name ${{ env.CONTAINER_NAME }} \
            --network ${{ env.APP_NETWORK }} \
            --env-file .env \
            -e NODE_ENV=production \
            --restart unless-stopped \
            --label "com.igfv.version=$VERSION" \
            igfv:$VERSION

          echo "âœ… Container replaced (downtime: ~2-5 seconds)"

      - name: Connect to proxy network
        run: |
          echo "ğŸ”— Connecting to proxy-network..."
          docker network connect proxy-network ${{ env.CONTAINER_NAME }} 2>/dev/null || echo "Already connected"
          echo "âœ… Connected to proxy-network"

      - name: Verify production deployment
        timeout-minutes: 2
        run: |
          echo "ğŸ” Verifying production container..."

          sleep 5

          # Check container is running
          if ! docker ps | grep -q ${{ env.CONTAINER_NAME }}; then
            echo "âŒ Container not running"
            docker logs ${{ env.CONTAINER_NAME }} --tail 100
            exit 1
          fi

          echo "âœ… Container is running"

          # Get container IP
          CONTAINER_IP=$(docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' ${{ env.CONTAINER_NAME }})
          echo "ğŸ“ Container IP: $CONTAINER_IP"

          # Quick health check (already pre-validated)
          for i in {1..8}; do
            if curl -sf --max-time 5 http://$CONTAINER_IP:5002 > /dev/null; then
              echo "âœ… Production container healthy (attempt $i/8)"
              
              ENCODING=$(curl -sI -H "Accept-Encoding: br, gzip" http://$CONTAINER_IP:5002 | grep -i content-encoding || echo "")
              if [ -n "$ENCODING" ]; then
                echo "ğŸ“Š $ENCODING"
              fi
              
              exit 0
            fi
            echo "â³ Waiting... ($i/8)"
            sleep 5
          done

          echo "âš ï¸ Production container slow to respond (but pre-validation passed)"
          docker logs ${{ env.CONTAINER_NAME }} --tail 50

      - name: Test via NPM
        continue-on-error: true
        run: |
          echo "ğŸŒ Testing public access via NPM..."

          if docker exec nginx-proxy-manager curl -sf http://igfv:5002 > /dev/null 2>&1; then
            echo "âœ… NPM can reach container"
          else
            echo "âš ï¸ NPM cannot reach container (check NPM proxy host config)"
          fi

      - name: Cleanup old images
        if: success()
        run: |
          echo "ğŸ§¹ Cleaning up old images..."

          # Keep last 3 versions + candidate tag
          docker images igfv --format "{{.ID}} {{.CreatedAt}}" | \
            sort -rk 2 | tail -n +5 | awk '{print $1}' | \
            xargs -r docker rmi -f 2>/dev/null || true

          docker image prune -f
          echo "âœ… Cleanup complete"

      - name: Emergency rollback
        if: failure()
        run: |
          echo "ğŸš¨ DEPLOYMENT FAILED"

          # If pre-validation failed, production was never touched
          if docker ps | grep -q ${{ env.CONTAINER_NAME }}; then
            echo "â„¹ï¸ Production container still running (pre-validation failed)"
            exit 0
          fi

          # If we got here, replacement happened but verification failed
          echo "ğŸ”„ Attempting emergency rollback..."

          # Stop failed container
          docker stop ${{ env.CONTAINER_NAME }} 2>/dev/null || true
          docker rm ${{ env.CONTAINER_NAME }} 2>/dev/null || true

          # Get previous image (second in list)
          PREV_IMAGE=$(docker images igfv --format "{{.ID}}" | sed -n '2p')

          if [ -n "$PREV_IMAGE" ]; then
            echo "ğŸ”„ Starting previous version..."
            
            docker run -d \
              --name ${{ env.CONTAINER_NAME }} \
              --network ${{ env.APP_NETWORK }} \
              --env-file .env \
              -e NODE_ENV=production \
              --restart unless-stopped \
              $PREV_IMAGE
            
            docker network connect proxy-network ${{ env.CONTAINER_NAME }} 2>/dev/null || true
            
            sleep 10
            
            if docker ps | grep -q ${{ env.CONTAINER_NAME }}; then
              echo "âœ… Rolled back to previous version"
              
              CONTAINER_IP=$(docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' ${{ env.CONTAINER_NAME }})
              if curl -sf --max-time 5 http://$CONTAINER_IP:5002 > /dev/null; then
                echo "âœ… Rollback successful - site is responding"
              fi
            else
              echo "âŒ Rollback failed - manual intervention required"
              docker logs ${{ env.CONTAINER_NAME }} --tail 50
            fi
          else
            echo "âŒ No previous image found for rollback"
            echo "âš ï¸ Manual recovery needed"
          fi

      - name: Deployment summary
        if: always()
        run: |
          STATUS="${{ job.status }}"

          echo "========================================"
          if [ "$STATUS" = "success" ]; then
            echo "âœ… DEPLOYMENT SUCCESSFUL"
            echo "========================================"
            echo "ğŸŒ Site: https://igfv.veka.gg"
            echo "ğŸ“¦ Version: ${{ steps.version.outputs.VERSION }}"
            echo "ğŸ—œï¸ Compression: Brotli + Gzip"
            echo "â±ï¸ Downtime: ~2-5 seconds"
            echo "ğŸ›¡ï¸ Pre-validated before swap"
            echo "â° Deployed: $(date '+%Y-%m-%d %H:%M:%S')"
            echo ""
            echo "ğŸ”— Access points:"
            echo "  - Public: https://igfv.veka.gg"
            echo "  - NPM: http://192.168.1.97 â†’ igfv:5002"
            echo "  - Direct: http://$(docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' ${{ env.CONTAINER_NAME }}):5002"
            echo ""
            echo "ğŸ“Š Current status:"
            docker ps --filter "name=igfv" --format "table {{.Names}}\t{{.Status}}\t{{.Image}}"
          else
            echo "âŒ DEPLOYMENT FAILED"
            echo "========================================"
            echo "ğŸ›¡ï¸ Production protected by pre-validation"
            echo ""
            echo "ğŸ“Š Current containers:"
            docker ps -a --filter "name=igfv" --format "table {{.Names}}\t{{.Status}}\t{{.Image}}"
            echo ""
            echo "ğŸ” Troubleshooting:"
            echo "  1. Check build logs above"
            echo "  2. Review container logs: docker logs igfv"
            echo "  3. Test container manually: docker logs igfv-test (if exists)"
            echo ""
            echo "ğŸ’¡ If production is down, rollback was attempted automatically"
          fi
          echo "========================================"
